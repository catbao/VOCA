!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3-color")):"function"==typeof define&&define.amd?define(["exports","d3-color"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).kde={},t.d3)}(this,(function(t,n){"use strict";function a(t,n){return null==t?n:"function"==typeof t?t:n=>n[t]}function o(t,n=!1){const a=new Float64Array(5),o=new Float64Array(4);!function(t,n,a){const o=4,e=Float64Array.of(.84,1.8675,.84,-1.8675,-.34015,-.1299,-.34015,.1299),r=Math.exp(-1.783/a),i=Math.exp(-1.723/a),s=.6318/a,c=1.997/a,l=Float64Array.of(-r*Math.cos(s),r*Math.sin(s),-r*Math.cos(-s),r*Math.sin(-s),-i*Math.cos(c),i*Math.sin(c),-i*Math.cos(-c),i*Math.sin(-c)),u=2.5066282746310007*a,f=Float64Array.of(e[0],e[1],0,0,0,0,0,0),h=Float64Array.of(1,0,l[0],l[1],0,0,0,0,0,0);let d,b;for(b=2;b<8;b+=2){for(f[b]=l[b]*f[b-2]-l[b+1]*f[b-1],f[b+1]=l[b]*f[b-1]+l[b+1]*f[b-2],d=b-2;d>0;d-=2)f[d]+=l[b]*f[d-2]-l[b+1]*f[d-1],f[d+1]+=l[b]*f[d-1]+l[b+1]*f[d-2];for(d=0;d<=b;d+=2)f[d]+=e[b]*h[d]-e[b+1]*h[d+1],f[d+1]+=e[b]*h[d+1]+e[b+1]*h[d];for(h[b+2]=l[b]*h[b]-l[b+1]*h[b+1],h[b+3]=l[b]*h[b+1]+l[b+1]*h[b],d=b;d>0;d-=2)h[d]+=l[b]*h[d-2]-l[b+1]*h[d-1],h[d+1]+=l[b]*h[d-1]+l[b+1]*h[d-2]}for(b=0;b<o;++b)d=b<<1,n[b]=f[d]/u,t[b+1]=h[d+2]}(a,o,t);const e=Float64Array.of(0,o[1]-a[1]*o[0],o[2]-a[2]*o[0],o[3]-a[3]*o[0],-a[4]*o[0]),r=1+a[1]+a[2]+a[3]+a[4];return{sigma:t,negative:n,a,b_causal:o,b_anticausal:e,sum_causal:(o[0]+o[1]+o[2]+o[3])/r,sum_anticausal:(e[1]+e[2]+e[3]+e[4])/r}}function e(t,n,a,o=1,e=new Float64Array(a),i=new Float64Array(a),s=new Float64Array(5),c=e,l=r){const u=2*o,f=3*o,h=4*o,d=o*a;let b,y;for(l(e,n,a,o,t.b_causal,3,t.a,4,t.sum_causal,s,t.sigma),y=4,b=h;y<a;++y,b+=o)e[y]=t.b_causal[0]*n[b]+t.b_causal[1]*n[b-o]+t.b_causal[2]*n[b-u]+t.b_causal[3]*n[b-f]-t.a[1]*e[y-1]-t.a[2]*e[y-2]-t.a[3]*e[y-3]-t.a[4]*e[y-4];for(l(i,n,a,-o,t.b_anticausal,4,t.a,4,t.sum_anticausal,s,t.sigma),y=4,b=d-5*o;y<a;++y,b-=o)i[y]=t.b_anticausal[1]*n[b+o]+t.b_anticausal[2]*n[b+u]+t.b_anticausal[3]*n[b+f]+t.b_anticausal[4]*n[b+h]-t.a[1]*i[y-1]-t.a[2]*i[y-2]-t.a[3]*i[y-3]-t.a[4]*i[y-4];if(t.negative)for(y=0,b=0;y<a;++y,b+=o)c[b]=e[y]+i[a-y-1];else for(y=0,b=0;y<a;++y,b+=o)c[b]=Math.max(0,e[y]+i[a-y-1]);return c}function r(t,n,a,o,e,r,i,s,c,l,u,f=.5){const h=Math.abs(o)*a,d=o<0?h+o:0;let b,y,m;for(y=0;y<s;++y)for(l[y]=y<=r?e[y]:0,m=1;m<=s&&m<=y;++m)l[y]-=i[m]*l[y-m];for(m=0;m<s;++m)for(t[m]=0,y=1;y<=m;++y)b=d+o*y,b>=0&&b<h&&(t[m]+=l[m-y]*n[b]);const g=n[d],p=Math.ceil(10*u);for(y=0;y<p;++y){for(m=0;m<s;++m)t[m]+=l[m]*g;if((c-=Math.abs(l[0]))<=f)break;for(l[s]=y+s<=r?e[y+s]:0,m=1;m<=s;++m)l[s]-=i[m]*l[s-m];for(m=0;m<s;++m)l[m]=l[m+1]}}function i(t,n,a=0){const o=t.length;let e,r;for(let a=0;a<o;++a){const o=n(t[a],a,t);null!=o&&(void 0===e?o>=o&&(e=r=o):(o<e&&(e=o),o>r&&(r=o)))}return[e-a,r+a]}function s(t,n){const a=t.map(n).filter((t=>null!=t&&t>=t));a.sort(((t,n)=>t-n));const o=function(t){const n=t.length;let a,o=0,e=0,r=0;for(let i=0;i<n;++i){const n=t[i];a=n-e,e+=a/++o,r+=a*(n-e)}return o>1?Math.sqrt(r/(o-1)):NaN}(a),e=c(a,.25),r=c(a,.75),i=a.length,s=(r-e)/1.34;return 1.06*(Math.min(o,s)||o||Math.abs(e)||1)*Math.pow(i,-.2)}function c(t,n){const a=t.length;if(!a)return NaN;if((n=+n)<=0||a<2)return t[0];if(n>=1)return t[a-1];const o=(a-1)*n,e=Math.floor(o),r=t[e];return r+(t[e+1]-r)*(o-e)}function l(t,a,o,e=h(0,0,0),[r,i]=[f(t,0),u(t,0)],s=function(t,n){if("undefined"!=typeof document){const a=document.createElement("canvas");return a.setAttribute("width",t),a.setAttribute("height",n),a}throw"Can not create a canvas instance, provide a canvas as a parameter."}(a,o),c=256){const l=1/(i-r),d=s.getContext("2d"),b=d.getImageData(0,0,a,o),y=b.data,m=c-1,g=function(t,a){const o=new Uint8ClampedArray(4*(t+1));for(let e=0;e<=t;++e){const r=a(e/t),{r:i,g:s,b:c,opacity:l=1}="string"==typeof r?n.rgb(r):r,u=e<<2;o[u+0]=i,o[u+1]=s,o[u+2]=c,o[u+3]=255*l|0}return o}(m,e);for(let n=0,e=0;n<o;++n)for(let i=0,s=(o-n-1)*a;i<a;++i,e+=4){const n=m*Math.min(1,Math.max(t[i+s]-r,0)*l)<<2;y[e+0]=g[n+0],y[e+1]=g[n+1],y[e+2]=g[n+2],y[e+3]=g[n+3]}return d.putImageData(b,0,0),s}function u(t,n){const a=t.length;for(let o=0;o<a;++o)t[o]>n&&(n=t[o]);return n}function f(t,n){const a=t.length;for(let o=0;o<a;++o)t[o]<n&&(n=t[o]);return n}function h(t,n,a){return o=>({r:t,g:n,b:a,opacity:o})}function d(t){return null==t?[void 0,void 0]:"number"==typeof t?[t,t]:t}t.density1d=function(t,n={}){const{adjust:r=1,pad:c=3,bins:l=512}=n,u=a(n.x,(t=>t)),f=a(n.weight,(()=>1/t.length));let h=n.bandwidth??r*s(t,u);const[d,b]=n.extent??i(t,u,c*h),y=function(t,n,a,o,e,r){const i=new Float64Array(r),s=(r-1)/(e-o);for(let e=0;e<t.length;++e){const c=t[e],l=n(c,e,t),u=a(c,e,t);if(!Number.isFinite(l)||!Number.isFinite(u))continue;const f=(l-o)*s,h=Math.floor(f),d=h+1;0<=h&&d<r?(i[h]+=(d-f)*u,i[d]+=(f-h)*u):-1===h?i[d]+=(f-h)*u:d===r&&(i[h]+=(d-f)*u)}return i}(t,u,f,d,b,l),m=(b-d)/(l-1),g=y.some((t=>t<0));let p,M=o(h/m,g);function*w(t="x",n="y"){const a=F.grid(),o=1/m;for(let e=0;e<l;++e)yield{[t]:d+e*m,[n]:a[e]*o}}const F={[Symbol.iterator]:w,points:w,grid:()=>p||(p=e(M,y,l)),extent:()=>[d,b],bandwidth(t){return arguments.length?(t!==h&&(h=t,p=null,M=o(h/m,g)),F):h}};return F},t.density2d=function(t,n={}){const{adjust:r=1,pad:c=3,bins:u=[256,256]}=n,f=a(n.x,(t=>t[0])),h=a(n.y,(t=>t[1])),b=a(n.weight,(()=>1/t.length));let[y=r*s(t,f),m=r*s(t,h)]=d(n.bandwidth);const[[g,p]=i(t,f,c*y),[M,w]=i(t,h,c*m)]=null==(F=n.extent)?[void 0,void 0]:"number"==typeof F[0]?[F,F]:F;var F;const[x,A]=d(u),_=function(t,n,a,o,e,r,i,s,c,l){const u=new Float64Array(i*l),f=(i-1)/(r-e),h=(l-1)/(c-s);for(let r=0;r<t.length;++r){const c=t[r],d=n(c,r,t),b=a(c,r,t),y=o(c,r,t);if(!(Number.isFinite(d)&&Number.isFinite(b)&&Number.isFinite(y)))continue;const m=(d-e)*f,g=Math.floor(m),p=g+1,M=(b-s)*h,w=Math.floor(M),F=w+1;0<=g&&p<i?0<=w&&F<l?(u[g+w*i]+=(p-m)*(F-M)*y,u[g+F*i]+=(p-m)*(M-w)*y,u[p+w*i]+=(m-g)*(F-M)*y,u[p+F*i]+=(m-g)*(M-w)*y):-1===w?(u[g+F*i]+=(p-m)*(M-w)*y,u[p+F*i]+=(m-g)*(M-w)*y):F===l&&(u[p+w*i]+=(m-g)*(F-M)*y,u[g+w*i]+=(p-m)*(F-M)*y):-1===g?0<=w&&F<l?(u[p+w*i]+=(m-g)*(F-M)*y,u[p+F*i]+=(m-g)*(M-w)*y):-1===w?u[p+F*i]+=(m-g)*(M-w)*y:F===l&&(u[p+w*i]+=(m-g)*(F-M)*y):p===i&&(0<=w&&F<l?(u[g+w*i]+=(p-m)*(F-M)*y,u[g+F*i]+=(p-m)*(M-w)*y):-1===w?u[g+F*i]+=(p-m)*(M-w)*y:F===l&&(u[g+w*i]+=(p-m)*(F-M)*y))}return u}(t,f,h,b,g,p,x,M,w,A),v=(p-g)/(x-1),N=(w-M)/(A-1),C=_.some((t=>t<0));let j,k=o(y/v,C),q=o(m/N,C);function*D(t="x",n="y",a="z"){const o=I.grid(),e=1/(v*N);for(let r=0,i=0;i<A;++i)for(let s=0;s<x;++s,++r)yield{[t]:g+s*v,[n]:M+i*N,[a]:o[r]*e}}const I={[Symbol.iterator]:D,points:D,grid:()=>j||(j=function(t,n,a,[o,r]){const i=new Float64Array(Math.max(o,r)),s=new Float64Array(Math.max(o,r)),c=new Float64Array(5),l=new Float64Array(a.length);for(let n=0,u=0;n<r;++n,u+=o){const n=l.subarray(u);e(t,a.subarray(u),o,1,i,s,c,n)}for(let t=0;t<o;++t){const a=l.subarray(t);e(n,a,r,o,i,s,c,a)}return l}(k,q,_,[x,A])),extent:()=>[[g,p],[M,w]],heatmap:({color:t,clamp:n,canvas:a,maxColors:o}={})=>l(I.grid(),x,A,t,n,a,o),bandwidth(t){if(arguments.length){const[n,a]=d(t);return n!==y&&(j=null,k=o((y=n)/v,C)),a!==m&&(j=null,q=o((m=a)/N,C)),I}return[y,m]}};return I},t.nrd=s,t.opacityMap=h}));
//# sourceMappingURL=fast-kde.min.js.map
